#!/bin/bash

BUILD_DIR=$1

indent() {
  sed 's/^/       /'
}

LOGSTASH_VERSION=${LOGSTASH_VERSION:-9.0.1}

BUILDPACK_PATH=$(dirname $(readlink -f $0))/../

echo "Downloading Logstash version $LOGSTASH_VERSION" | indent

if [ ${LOGSTASH_VERSION:0:1} = "6" ]
then
  URL=https://artifacts.elastic.co/downloads/logstash/logstash-$LOGSTASH_VERSION.tar.gz
else
  URL=https://artifacts.elastic.co/downloads/logstash/logstash-oss-$LOGSTASH_VERSION-linux-x86_64.tar.gz
fi
curl $URL -L --silent -o /tmp/logstash.tar.gz

echo "Extracting logstash" | indent
tar -xf /tmp/logstash.tar.gz -C $BUILD_DIR

mv "${BUILD_DIR}/config" "${BUILD_DIR}/user_config"

mv "${BUILD_DIR}/logstash-${LOGSTASH_VERSION}/"* "${BUILD_DIR}/"
rmdir "${BUILD_DIR}/logstash-${LOGSTASH_VERSION}"

mv "${BUILD_DIR}/user_config/"* "${BUILD_DIR}/config/"
rmdir "${BUILD_DIR}/usr_config"

export PATH="${PATH}:${BUILD_DIR}/bin"

echo "Installing plugins" | indent

for plugin in $(echo $LOGSTASH_PLUGINS | sed "s/,/ /g") ; do
  echo "Installing plugin $plugin" | indent
  bin/logstash-plugin install $plugin | indent
done

# mkdir -p $BUILD_DIR/bin
# cp $BUILDPACK_PATH/bin/logstash $BUILD_DIR/bin/logstash

echo "Done" | indent
